<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>POUDRI√àRE ‚Äî Simulation diplomatique 1890‚Äì1914</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Crimson+Pro:wght@300;400;600;700&family=Special+Elite&display=swap" rel="stylesheet">
<style>
:root{--bg:#080604;--card:#1a1510;--border:#3a3530;--gold:#c4a35a;--text:#c0b8a8;--dim:#8a8070;--faint:#6a5a40;--red:#e63946;--green:#81b29a;--blue:#6a9fd8;--orange:#e07a5f;--cream:#f5f0e1}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg);color:var(--text);font-family:'Crimson Pro',Georgia,serif;min-height:100vh}
h1,h2,h3{font-family:'Playfair Display',serif;font-weight:400}
.container{max-width:900px;margin:0 auto;padding:16px}
.btn{padding:10px 24px;font-family:'Crimson Pro',serif;font-size:13px;font-weight:600;letter-spacing:2px;text-transform:uppercase;border:none;border-radius:3px;cursor:pointer;transition:all .3s}
.btn-gold{background:linear-gradient(135deg,var(--gold),#8a6a2a);color:var(--bg)}
.btn-red{background:linear-gradient(135deg,var(--red),#8a1a2a);color:#fff}
.btn-ghost{background:none;border:1px solid var(--border);color:var(--dim)}
.btn:disabled{opacity:.4;cursor:default}
.panel{background:var(--card);border:1px solid var(--border);border-radius:5px;padding:20px;margin-bottom:16px}
.panel-hdr{font-size:11px;letter-spacing:3px;color:var(--faint);text-transform:uppercase;margin-bottom:14px}
.gauge{margin-bottom:8px}
.gauge-lbl{font-size:11px;color:var(--dim);margin-bottom:3px}
.gauge-track{height:10px;background:#2a2520;border-radius:2px;overflow:hidden;border:1px solid var(--border)}
.gauge-fill{height:100%;border-radius:2px;transition:width .8s}
.tension-box{text-align:center;padding:10px 0;margin-bottom:12px}
.tension-track{position:relative;height:28px;background:var(--bg);border-radius:3px;overflow:hidden;border:1px solid var(--border);max-width:500px;margin:8px auto 0}
.tension-fill{height:100%;transition:width 1s}
.tension-txt{position:absolute;top:0;left:0;right:0;bottom:0;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#fff;text-shadow:0 1px 3px #000}
.code-box{font-family:'Special Elite',monospace;font-size:24px;letter-spacing:4px;color:var(--gold);background:var(--bg);padding:10px 20px;border:2px solid var(--gold);border-radius:4px;display:inline-block;margin:12px 0}
.nation-card{border:2px solid #2a2520;border-radius:4px;padding:12px;cursor:pointer;transition:all .3s;background:var(--bg)}
.nation-card.sel{border-color:var(--gold);background:var(--card)}
.nation-card.taken{opacity:.4;pointer-events:none}
.dec-card{background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:14px;cursor:pointer;transition:all .2s;margin-bottom:10px}
.dec-card:hover{border-color:var(--gold);background:var(--card)}
.tag{display:inline-block;font-size:10px;padding:2px 6px;border-radius:2px;background:#2a2520;margin:2px}
.tg-msg{background:#ede8d8;border:1px solid #8a7a60;padding:8px 10px;margin-bottom:6px;border-radius:2px;font-family:'Special Elite',monospace;font-size:11px;color:#2a2010}
.overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.85);z-index:100;display:flex;align-items:center;justify-content:center}
.modal{background:var(--card);border:2px solid var(--gold);border-radius:6px;padding:24px;max-width:450px;width:92%;max-height:80vh;overflow-y:auto}
.tg-paper{background:var(--cream);border:3px double #8a7a60;padding:20px;font-family:'Special Elite',monospace;color:#2a2010;max-width:400px;width:92%}
input[type="text"],select,textarea{background:var(--bg);border:1px solid var(--border);color:var(--text);padding:8px 12px;font-family:inherit;font-size:14px;border-radius:3px;width:100%}
input:focus,select:focus,textarea:focus{outline:none;border-color:var(--gold)}
.info{display:inline-block;width:14px;height:14px;background:var(--border);border-radius:50%;font-size:10px;text-align:center;line-height:14px;color:var(--dim);cursor:help;margin-left:4px}
.briefing{background:linear-gradient(135deg,#221c14,var(--card));border:1px solid var(--border);border-radius:6px;padding:16px;margin-bottom:16px}
@keyframes pulse{0%,100%{box-shadow:0 0 15px rgba(230,57,70,.3)}50%{box-shadow:0 0 30px rgba(230,57,70,.5)}}
.pulse{animation:pulse 2s infinite}
</style>
</head>
<body>
<div id="app"></div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script>
// Firebase config
firebase.initializeApp({
  apiKey: "AIzaSyAxTyBmMn9Y7MyG3NpMoRvMrn7TE45V8lQ",
  authDomain: "forges-du-progres.firebaseapp.com",
  databaseURL: "https://forges-du-progres-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "forges-du-progres",
  storageBucket: "forges-du-progres.firebasestorage.app",
  messagingSenderId: "429109623434",
  appId: "1:429109623434:web:d6a36cb0a5b4a434f08b73"
});
const db = firebase.database();

// === GAME DATA ===
const NATIONS = {
  germany: {
    name: "Empire allemand", short: "Allemagne", flag: "üá©üá™", accent: "#c4a35a",
    leader: "Guillaume II", desc: "Puissance industrielle cherchant sa place au soleil.",
    allies: ["austria", "italy"], rivals: ["france", "russia"],
    mil: 70, ind: 80, pop: 55, dip: 50, pInd: 70, pMil: 65,
    brief: "L'Allemagne est la premi√®re puissance industrielle d'Europe. Le Kaiser Guillaume II r√™ve de faire de l'Allemagne une puissance mondiale. Vos objectifs : maintenir l'alliance austro-allemande, d√©velopper la flotte, obtenir des colonies, √©viter une guerre sur deux fronts."
  },
  france: {
    name: "R√©publique fran√ßaise", short: "France", flag: "üá´üá∑", accent: "#e63946",
    leader: "Poincar√©", desc: "La Revanche hante les esprits depuis 1871.",
    allies: ["russia"], rivals: ["germany"],
    mil: 60, ind: 60, pop: 50, dip: 65, pInd: 55, pMil: 50,
    brief: "Humili√©e en 1871, la France a perdu l'Alsace-Lorraine. L'alliance avec la Russie est cruciale. Vos objectifs : r√©cup√©rer l'Alsace-Lorraine, maintenir l'alliance russe, vous rapprocher du Royaume-Uni, d√©fendre votre empire colonial."
  },
  britain: {
    name: "Royaume-Uni", short: "Royaume-Uni", flag: "üá¨üáß", accent: "#e07a5f",
    leader: "George V", desc: "Ma√Ætre des mers, pratiquant le splendide isolement.",
    allies: [], rivals: [],
    mil: 55, ind: 75, pop: 45, dip: 80, pInd: 75, pMil: 45,
    brief: "Le Royaume-Uni poss√®de le plus grand empire et la plus puissante marine. Traditionnellement, il √©vite les alliances permanentes. Vos objectifs : maintenir la supr√©matie navale, emp√™cher une puissance de dominer l'Europe, prot√©ger la Belgique."
  },
  austria: {
    name: "Autriche-Hongrie", short: "Autriche", flag: "üá¶üáπ", accent: "#f4a261",
    leader: "Fran√ßois-Joseph", desc: "Empire multinational menac√© par les nationalismes.",
    allies: ["germany"], rivals: ["russia"],
    mil: 50, ind: 45, pop: 40, dip: 45, pInd: 40, pMil: 55,
    brief: "L'empire austro-hongrois est un patchwork de 11 nationalit√©s. Le nationalisme menace son existence. Vos objectifs : maintenir l'unit√©, contr√¥ler les Balkans (surtout la Serbie), s'appuyer sur l'Allemagne."
  },
  russia: {
    name: "Empire russe", short: "Russie", flag: "üá∑üá∫", accent: "#81b29a",
    leader: "Nicolas II", desc: "Le colosse aux pieds d'argile, protecteur des Slaves.",
    allies: ["france"], rivals: ["austria"],
    mil: 65, ind: 35, pop: 60, dip: 40, pInd: 30, pMil: 60,
    brief: "La Russie est un g√©ant fragile. Le tsar r√®gne sur 170 millions de sujets mais le pays est en retard. Vos objectifs : prot√©ger les Slaves des Balkans, obtenir un acc√®s aux mers chaudes, maintenir l'alliance fran√ßaise, √©viter une r√©volution."
  },
  ottoman: {
    name: "Empire ottoman", short: "Ottoman", flag: "üè≥Ô∏è", accent: "#d4a574",
    leader: "Jeunes-Turcs", desc: "L'homme malade de l'Europe se modernise.",
    allies: [], rivals: ["russia"],
    mil: 35, ind: 25, pop: 35, dip: 30, pInd: 25, pMil: 50,
    brief: "L'Empire ottoman est en d√©clin depuis deux si√®cles. Les Jeunes-Turcs tentent de le moderniser. Vos objectifs : survivre, vous moderniser, trouver un alli√© puissant, emp√™cher la Russie d'acc√©der aux D√©troits."
  },
  italy: {
    name: "Royaume d'Italie", short: "Italie", flag: "üáÆüáπ", accent: "#90be6d",
    leader: "Victor-Emmanuel III", desc: "Membre de la Triplice mais lorgnant sur l'Autriche.",
    allies: ["germany", "austria"], rivals: [],
    mil: 40, ind: 40, pop: 40, dip: 55, pInd: 45, pMil: 35,
    brief: "L'Italie fait partie de la Triplice mais convoite les terres italiennes sous domination autrichienne. Vos objectifs : r√©cup√©rer le Trentin et Trieste, obtenir des colonies, rester flexible entre les blocs."
  }
};

const TURNS = [
  { id: 1, year: "1890-1898", title: "La fin de Bismarck", 
    desc: "Bismarck est renvoy√©. Guillaume II lance la Weltpolitik.", 
    event: "L'Allemagne refuse le trait√© avec la Russie. La France propose une alliance √† Saint-P√©tersbourg.",
    context: "Bismarck maintenait la paix par un syst√®me d'alliances complexe. Guillaume II pense faire mieux...",
    baseTension: 15 },
  { id: 2, year: "1898-1905", title: "Course navale", 
    desc: "L'amiral Tirpitz lance la flotte allemande. Crise de Tanger au Maroc.",
    event: "Guillaume II conteste l'influence fran√ßaise au Maroc. Le Royaume-Uni s'alarme de la flotte allemande.",
    context: "Chaque cuirass√© allemand pousse le Royaume-Uni √† en construire davantage.",
    baseTension: 30 },
  { id: 3, year: "1905-1909", title: "Crise bosniaque", 
    desc: "L'Autriche annexe la Bosnie. La Russie humili√©e jure de ne plus reculer.",
    event: "L'annexion provoque une crise majeure. Les Balkans deviennent la poudri√®re de l'Europe.",
    context: "La Serbie devient le foyer du nationalisme slave. Des soci√©t√©s secr√®tes r√™vent de lib√©rer les Slaves.",
    baseTension: 50 },
  { id: 4, year: "1911-1913", title: "Guerres balkaniques", 
    desc: "Crise d'Agadir. Les guerres balkaniques redessinent les fronti√®res.",
    event: "La Serbie double son territoire. L'Autriche veut r√©gler le probl√®me serbe.",
    context: "Le chef d'√©tat-major autrichien a demand√© 25 fois l'autorisation d'attaquer la Serbie.",
    baseTension: 65 },
  { id: 5, year: "√ât√© 1914", title: "Sarajevo", 
    desc: "Fran√ßois-Ferdinand assassin√©. L'engrenage des alliances s'active.",
    event: "Ultimatum √† la Serbie. Mobilisation russe. Ch√®que en blanc allemand. Compte √† rebours.",
    context: "Chaque nation a ses raisons d'entrer en guerre, mais aucune ne veut une guerre g√©n√©rale.",
    baseTension: 85 }
];

const DECISIONS = {
  1: [
    { id: "d1a", text: "Augmenter le budget militaire", desc: "Investir dans l'arm√©e et la marine.", fx: { mil: 15, ind: -5, pop: -5 }, tension: 5, tag: "militariste" },
    { id: "d1b", text: "Chercher de nouvelles alliances", desc: "Intensifier les contacts diplomatiques.", fx: { dip: 15, pop: 5 }, tension: -3, tag: "diplomate" },
    { id: "d1c", text: "D√©velopper l'industrie", desc: "Investir dans l'√©conomie et les colonies.", fx: { ind: 15, pop: 5 }, tension: 3, tag: "expansionniste" },
    { id: "d1d", text: "Proposer un congr√®s de paix", desc: "Appeler √† une conf√©rence internationale.", fx: { dip: 10, pop: 10, mil: -5 }, tension: -8, tag: "pacifiste" }
  ],
  2: [
    { id: "d2a", text: "Construire des cuirass√©s", desc: "Lancer un programme naval.", fx: { mil: 20, ind: 5, pop: -5 }, tension: 8, tag: "militariste" },
    { id: "d2b", text: "Soutenir un alli√© dans la crise", desc: "Afficher publiquement votre soutien.", fx: { dip: 10, mil: 5, pop: 5 }, tension: 10, tag: "provocateur" },
    { id: "d2c", text: "N√©gocier des compensations", desc: "Chercher un compromis commercial.", fx: { ind: 10, dip: 10 }, tension: -2, tag: "diplomate" },
    { id: "d2d", text: "Rester neutre", desc: "Ne pas s'impliquer, d√©fenses int√©rieures.", fx: { mil: 10, pop: 10 }, tension: -5, tag: "isolationniste" }
  ],
  3: [
    { id: "d3a", text: "Soutien militaire balkanique", desc: "Envoyer des conseillers ou du mat√©riel.", fx: { mil: 10, dip: 5 }, tension: 12, tag: "provocateur" },
    { id: "d3b", text: "Exiger des concessions", desc: "R√©clamer des avantages territoriaux.", fx: { pop: 10, mil: 5 }, tension: 8, tag: "expansionniste" },
    { id: "d3c", text: "Conf√©rence de paix", desc: "Appeler √† une m√©diation internationale.", fx: { dip: 15, pop: 5, mil: -10 }, tension: -10, tag: "pacifiste" },
    { id: "d3d", text: "Espionner les rivaux", desc: "Renforcer les services de renseignement.", fx: { dip: 5, mil: 5 }, tension: 5, tag: "espion" }
  ],
  4: [
    { id: "d4a", text: "Mobilisation partielle", desc: "Mettre une partie de l'arm√©e en alerte.", fx: { mil: 20, pop: -10, ind: -10 }, tension: 15, tag: "militariste" },
    { id: "d4b", text: "Envoyer un ultimatum", desc: "Exiger des concessions sous menace.", fx: { mil: 5, dip: -15, pop: 10 }, tension: 18, tag: "provocateur" },
    { id: "d4c", text: "Trait√© de non-agression", desc: "Proposer un accord de paix.", fx: { dip: 20, pop: 10, mil: -5 }, tension: -12, tag: "pacifiste" },
    { id: "d4d", text: "Renforcer les alliances", desc: "Coordonner les plans avec vos alli√©s.", fx: { dip: 10, mil: 10 }, tension: 5, tag: "strat√®ge" }
  ],
  5: [
    { id: "d5a", text: "MOBILISATION G√âN√âRALE", desc: "C'est probablement la guerre.", fx: { mil: 25, dip: -20, pop: -5 }, tension: 25, tag: "guerre" },
    { id: "d5b", text: "M√©diation de derni√®re minute", desc: "Soutenir l'alli√© tout en proposant une conf√©rence.", fx: { dip: 10, mil: 10, pop: 5 }, tension: 8, tag: "m√©diation" },
    { id: "d5c", text: "Neutralit√© totale", desc: "Se retirer des alliances.", fx: { dip: -10, pop: 15, mil: -10 }, tension: -15, tag: "neutralit√©" },
    { id: "d5d", text: "Trahir son alliance", desc: "Changer de camp.", fx: { dip: -20, pop: -15, mil: 5 }, tension: 10, tag: "trahison" }
  ]
};

// === STATE ===
let room = null;
let role = null; // 'master' or nationId
let state = null;
let playerId = localStorage.getItem('poud_pid') || ('p' + Math.random().toString(36).substr(2, 8));
localStorage.setItem('poud_pid', playerId);

const app = document.getElementById('app');
const clamp = (v, lo = 0, hi = 100) => Math.max(lo, Math.min(hi, v));

// === FIREBASE ===
function genCode() {
  const c = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let r = 'WWI-';
  for (let i = 0; i < 4; i++) r += c[Math.floor(Math.random() * c.length)];
  return r;
}

function subscribe(code) {
  db.ref('poudriere/' + code).on('value', snap => {
    state = snap.val();
    render();
  });
}

function set(path, val) {
  if (room) db.ref('poudriere/' + room + '/' + path).set(val);
}

function update(obj) {
  if (room) db.ref('poudriere/' + room).update(obj);
}

// === HELPERS ===
function tensionColor(v) {
  if (v < 30) return '#81b29a';
  if (v < 50) return '#f2cc8f';
  if (v < 70) return '#e07a5f';
  return '#e63946';
}

function tensionLabel(v) {
  if (v < 20) return 'Paix relative';
  if (v < 40) return 'Tensions';
  if (v < 60) return 'Crise grave';
  if (v < 80) return 'Au bord du gouffre';
  return 'POUDRI√àRE';
}

function renderTension(t) {
  var c = tensionColor(t);
  return '<div class="tension-box">' +
    '<div style="font-size:11px;color:var(--dim);letter-spacing:2px;text-transform:uppercase">TENSION EUROP√âENNE</div>' +
    '<div class="tension-track">' +
    '<div class="tension-fill" style="width:' + clamp(t) + '%;background:linear-gradient(90deg,#81b29a,' + c + ')"></div>' +
    '<div class="tension-txt">' + Math.round(t) + '% ‚Äî ' + tensionLabel(t) + '</div>' +
    '</div></div>';
}

function renderGauge(val, color, label) {
  return '<div class="gauge">' +
    '<div class="gauge-lbl">' + label + '</div>' +
    '<div class="gauge-track"><div class="gauge-fill" style="width:' + clamp(val) + '%;background:' + color + '"></div></div>' +
    '</div>';
}

// === MAIN RENDER ===
function render() {
  console.log('render() - room:', room, 'role:', role, 'state:', state ? state.phase : 'null');
  if (!room) { renderLobby(); return; }
  if (!state) { app.innerHTML = '<div class="container" style="text-align:center;padding:60px"><p style="color:var(--dim)">Connexion...</p></div>'; return; }
  if (role === 'master') renderMaster();
  else renderNation();
}

// === LOBBY ===
function renderLobby() {
  app.innerHTML = '<div class="container" style="max-width:600px">' +
    '<div style="text-align:center;padding:40px 0">' +
    '<div style="font-size:11px;letter-spacing:6px;color:var(--faint);text-transform:uppercase">Simulation diplomatique</div>' +
    '<h1 style="font-size:48px;color:var(--gold);margin:8px 0">POUDRI√àRE</h1>' +
    '<div style="font-size:14px;color:var(--dim);font-style:italic">L\'Europe au bord de l\'ab√Æme, 1890‚Äì1914</div>' +
    '</div>' +
    '<div class="panel" style="margin-bottom:20px">' +
    '<h3 style="color:var(--gold);margin-bottom:12px">üìú Le contexte</h3>' +
    '<p style="font-size:13px;color:var(--dim);line-height:1.7">Nous sommes en <strong style="color:var(--text)">1890</strong>. L\'Europe est domin√©e par de grands empires li√©s par des <strong style="color:var(--text)">alliances</strong>. Vous incarnez le gouvernement d\'une grande puissance. Vos d√©cisions fa√ßonneront l\'histoire : la paix sera-t-elle pr√©serv√©e... ou la poudri√®re finira-t-elle par exploser ?</p>' +
    '</div>' +
    '<div class="panel" style="text-align:center">' +
    '<div class="panel-hdr">üëÅ Professeur</div>' +
    '<p style="font-size:13px;color:var(--dim);margin-bottom:12px">Cr√©er une partie et projeter l\'√©cran</p>' +
    '<button class="btn btn-gold" onclick="createRoom()">Cr√©er une partie</button>' +
    '</div>' +
    '<div class="panel" style="text-align:center">' +
    '<div class="panel-hdr">üéÆ √âl√®ve</div>' +
    '<p style="font-size:13px;color:var(--dim);margin-bottom:12px">Entrer le code affich√©</p>' +
    '<input type="text" id="joinCode" placeholder="WWI-XXXX" maxlength="8" style="width:150px;text-align:center;text-transform:uppercase;margin-bottom:10px"><br>' +
    '<button class="btn btn-ghost" onclick="joinRoom()">Rejoindre</button>' +
    '</div>' +
    '</div>';
}

window.createRoom = function() {
  var code = genCode();
  db.ref('poudriere/' + code).set({
    code: code, phase: 'lobby', selectedNations: Object.keys(NATIONS),
    players: {}, nationStates: {}, alliances: {}, decisions: {},
    tension: 10, turn: 0, eliminated: [], telegrams: [], history: []
  });
  room = code;
  role = 'master';
  subscribe(code);
};

window.joinRoom = function() {
  var code = document.getElementById('joinCode').value.toUpperCase().trim();
  if (!code) return;
  db.ref('poudriere/' + code).once('value', function(snap) {
    if (!snap.exists()) { alert('Partie introuvable'); return; }
    room = code;
    role = null;
    subscribe(code);
  });
};

// === MASTER VIEW ===
function renderMaster() {
  var s = state;
  if (s.phase === 'lobby') renderMasterLobby();
  else if (s.phase === 'event') renderMasterEvent();
  else if (s.phase === 'playing') renderMasterPlaying();
  else if (s.phase === 'resolution') renderMasterResolution();
  else if (s.phase === 'endgame') renderMasterEndgame();
}

function renderMasterLobby() {
  var s = state;
  var players = s.players || {};
  var taken = [];
  for (var id in players) { if (players[id].nation) taken.push(players[id].nation); }
  var count = Object.keys(players).length;

  var html = '<div class="container">' +
    '<div style="text-align:center;padding:20px 0">' +
    '<div style="font-size:10px;letter-spacing:4px;color:var(--faint)">üëÅ VUE MA√éTRE</div>' +
    '<h1 style="font-size:36px;color:var(--gold);margin:8px 0">POUDRI√àRE</h1>' +
    '<div class="code-box">' + room + '</div>' +
    '<p style="font-size:12px;color:var(--dim)">Les √©l√®ves entrent ce code pour rejoindre</p>' +
    '</div>';

  html += '<div class="panel"><div class="panel-hdr">üì° Joueurs connect√©s (' + count + ')</div>';
  if (count === 0) {
    html += '<p style="color:var(--dim);text-align:center">En attente des joueurs...</p>';
  } else {
    html += '<div style="display:flex;flex-wrap:wrap;gap:8px">';
    for (var id in players) {
      var p = players[id];
      var n = NATIONS[p.nation];
      html += '<div style="background:var(--bg);padding:6px 12px;border-radius:4px;border:1px solid ' + (n ? n.accent : 'var(--border)') + '">' +
        '<span style="font-size:18px">' + (n ? n.flag : '‚ùì') + '</span> ' +
        '<span style="font-size:12px;color:var(--text)">' + (n ? n.short : 'Choix...') + '</span></div>';
    }
    html += '</div>';
  }
  html += '</div>';

  html += '<div class="panel"><div class="panel-hdr">Nations disponibles</div>' +
    '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px">';
  var sel = s.selectedNations || [];
  for (var k in NATIONS) {
    var n = NATIONS[k];
    var isSel = sel.indexOf(k) >= 0;
    var isTaken = taken.indexOf(k) >= 0;
    html += '<div class="nation-card' + (isSel ? ' sel' : '') + '" onclick="toggleNation(\'' + k + '\')" style="' + (isSel ? 'border-color:' + n.accent : '') + '">' +
      '<div style="display:flex;align-items:center;gap:8px">' +
      '<span style="font-size:24px">' + n.flag + '</span>' +
      '<div><div style="font-size:13px;font-weight:700;color:' + (isSel ? n.accent : 'var(--dim)') + '">' + n.short + '</div>' +
      '<div style="font-size:10px;color:var(--dim)">' + (isTaken ? '‚úì Pris' : n.leader) + '</div></div>' +
      '</div></div>';
  }
  html += '</div></div>';

  html += '<div style="text-align:center;margin:20px 0">' +
    '<button class="btn btn-gold" onclick="startGame()"' + (count < 2 ? ' disabled' : '') + '>‚öî Lancer la simulation</button>';
  if (count < 2) html += '<div style="font-size:11px;color:var(--orange);margin-top:8px">Minimum 2 joueurs</div>';
  html += '</div></div>';

  app.innerHTML = html;
}

window.toggleNation = function(k) {
  var sel = state.selectedNations ? state.selectedNations.slice() : [];
  var i = sel.indexOf(k);
  if (i >= 0) sel.splice(i, 1); else sel.push(k);
  set('selectedNations', sel);
};

window.startGame = function() {
  var s = state;
  var players = s.players || {};
  var active = [];
  for (var id in players) { if (players[id].nation) active.push(players[id].nation); }
  if (active.length < 2) return;

  var nationStates = {};
  var alliances = {};
  for (var i = 0; i < active.length; i++) {
    var k = active[i];
    var n = NATIONS[k];
    nationStates[k] = { mil: n.mil, ind: n.ind, pop: n.pop, dip: n.dip };
    alliances[k] = n.allies.filter(function(a) { return active.indexOf(a) >= 0; });
  }

  update({
    phase: 'event', activeNations: active, nationStates: nationStates,
    alliances: alliances, turn: 1, tension: 10, decisions: {},
    telegrams: [], eliminated: [], history: []
  });
};

function renderMasterEvent() {
  var s = state;
  var t = TURNS[s.turn - 1];

  var html = '<div class="container">' +
    '<div style="text-align:center;margin-bottom:8px"><span style="font-size:10px;color:var(--faint)">üëÅ VUE MA√éTRE ‚Ä¢ ' + room + '</span></div>' +
    renderTension(s.tension) +
    '<div class="panel" style="text-align:center;border-color:rgba(196,163,90,0.3)">' +
    '<div style="font-size:11px;letter-spacing:3px;color:var(--faint)">TOUR ' + t.id + ' / 5</div>' +
    '<h2 style="font-size:28px;color:var(--gold);margin:8px 0">' + t.year + '</h2>' +
    '<div style="font-size:18px;color:var(--text);margin-bottom:16px">' + t.title + '</div>' +
    '<p style="font-size:14px;color:var(--dim);line-height:1.6;max-width:600px;margin:0 auto 16px">' + t.desc + '</p>' +
    '<div style="background:var(--bg);border:1px solid rgba(196,163,90,0.3);border-radius:4px;padding:14px;max-width:550px;margin:0 auto;text-align:left">' +
    '<div style="font-size:10px;color:var(--gold);letter-spacing:2px;margin-bottom:6px">üì∞ √âV√âNEMENT</div>' +
    '<div style="font-size:13px;color:var(--text);line-height:1.5">' + t.event + '</div>' +
    '<div style="font-size:12px;color:var(--dim);margin-top:10px;font-style:italic;border-top:1px solid var(--border);padding-top:8px">üí° ' + t.context + '</div>' +
    '</div></div>' +
    '<div style="text-align:center;margin-top:20px">' +
    '<button class="btn btn-gold" onclick="goPlaying()">Phase de d√©cision ‚Üí</button>' +
    '</div></div>';

  app.innerHTML = html;
}

window.goPlaying = function() {
  update({ phase: 'playing', decisions: {} });
};

function renderMasterPlaying() {
  var s = state;
  var t = TURNS[s.turn - 1];
  var active = s.activeNations || [];
  var elim = s.eliminated || [];
  var decisions = s.decisions || {};
  var playable = active.filter(function(n) { return elim.indexOf(n) < 0; });
  var submitted = playable.filter(function(n) { return decisions[n]; });
  var allDone = submitted.length === playable.length;

  var html = '<div class="container">' +
    '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">' +
    '<span style="font-size:10px;color:var(--faint)">üëÅ TOUR ' + t.id + ' ‚Ä¢ ' + t.year + '</span>' +
    '<span style="font-size:12px;color:' + (allDone ? 'var(--green)' : 'var(--dim)') + ';font-weight:700">' + submitted.length + '/' + playable.length + ' d√©cisions</span>' +
    '</div>' +
    renderTension(s.tension);

  html += '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px;margin:16px 0">';
  for (var i = 0; i < active.length; i++) {
    var nId = active[i];
    var n = NATIONS[nId];
    var st = s.nationStates[nId];
    var isElim = elim.indexOf(nId) >= 0;
    var done = !!decisions[nId];

    html += '<div style="background:rgba(0,0,0,0.3);border:2px solid ' + (isElim ? '#550020' : done ? 'var(--green)' : 'var(--border)') + ';border-radius:4px;padding:10px;opacity:' + (isElim ? '0.4' : '1') + '">' +
      '<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">' +
      '<span style="font-size:20px">' + n.flag + '</span>' +
      '<div><div style="font-size:12px;font-weight:700;color:' + n.accent + '">' + n.short + '</div>' +
      '<div style="font-size:9px;color:var(--dim)">' + (isElim ? '‚ùå R√©volution' : done ? '‚úì A vot√©' : '‚è≥ R√©fl√©chit') + '</div></div>' +
      '</div>';
    if (!isElim) {
      html += '<div style="font-size:9px">' +
        '<div style="display:flex;align-items:center;gap:4px;margin:2px 0"><span style="color:var(--red)">‚öî</span><div style="flex:1;height:4px;background:#2a2520;border-radius:2px"><div style="width:' + st.mil + '%;height:100%;background:var(--red);border-radius:2px"></div></div></div>' +
        '<div style="display:flex;align-items:center;gap:4px;margin:2px 0"><span style="color:var(--gold)">üí∞</span><div style="flex:1;height:4px;background:#2a2520;border-radius:2px"><div style="width:' + st.ind + '%;height:100%;background:var(--gold);border-radius:2px"></div></div></div>' +
        '<div style="display:flex;align-items:center;gap:4px;margin:2px 0"><span style="color:var(--green)">‚úä</span><div style="flex:1;height:4px;background:#2a2520;border-radius:2px"><div style="width:' + st.pop + '%;height:100%;background:var(--green);border-radius:2px"></div></div></div>' +
        '<div style="display:flex;align-items:center;gap:4px;margin:2px 0"><span style="color:var(--blue)">üïä</span><div style="flex:1;height:4px;background:#2a2520;border-radius:2px"><div style="width:' + st.dip + '%;height:100%;background:var(--blue);border-radius:2px"></div></div></div>' +
        '</div>';
    }
    html += '</div>';
  }
  html += '</div>';

  if (allDone) {
    html += '<div style="text-align:center;margin:20px 0"><button class="btn btn-red pulse" onclick="resolveTurn()">‚ö° R√©soudre le tour</button></div>';
  } else {
    html += '<div style="text-align:center;margin:20px 0;color:var(--dim);font-size:13px">En attente des d√©cisions...</div>';
  }
  html += '</div>';

  app.innerHTML = html;
}

window.resolveTurn = function() {
  var s = state;
  var t = TURNS[s.turn - 1];
  var active = s.activeNations || [];
  var decisions = s.decisions || {};
  var elim = s.eliminated ? s.eliminated.slice() : [];
  var nationStates = {};
  var alliances = {};
  for (var k in s.nationStates) nationStates[k] = Object.assign({}, s.nationStates[k]);
  for (var k in s.alliances) alliances[k] = s.alliances[k] ? s.alliances[k].slice() : [];

  var tensionDelta = 0;
  var events = [];

  for (var i = 0; i < active.length; i++) {
    var nId = active[i];
    if (elim.indexOf(nId) >= 0) continue;
    var dec = decisions[nId];
    if (!dec) continue;
    var st = nationStates[nId];
    var n = NATIONS[nId];

    if (dec.fx.mil) st.mil = clamp(st.mil + dec.fx.mil);
    if (dec.fx.ind) st.ind = clamp(st.ind + dec.fx.ind);
    if (dec.fx.pop) st.pop = clamp(st.pop + dec.fx.pop);
    if (dec.fx.dip) st.dip = clamp(st.dip + dec.fx.dip);

    var indGap = Math.abs(st.ind - n.pInd);
    if (indGap > 25) {
      var loss = Math.floor(indGap / 10);
      st.pop = clamp(st.pop - loss);
      events.push(n.flag + ' ' + n.short + ': pression industrielle (‚àí' + loss + ' stabilit√©)');
    }

    if (dec.tag === 'trahison') {
      events.push('üí• ' + n.flag + ' ' + n.short + ' TRAHIT ses alli√©s !');
      alliances[nId] = [];
      for (var k in alliances) {
        alliances[k] = alliances[k].filter(function(a) { return a !== nId; });
      }
    }

    tensionDelta += dec.tension;
  }

  for (var i = 0; i < active.length; i++) {
    var nId = active[i];
    var st = nationStates[nId];
    if (st && st.pop <= 15 && elim.indexOf(nId) < 0) {
      elim.push(nId);
      events.push('üî¥ R√âVOLUTION en ' + NATIONS[nId].short + ' !');
    }
  }

  var newTension = clamp(s.tension + tensionDelta * 0.4 + (t.baseTension - s.tension) * 0.3);
  var history = s.history ? s.history.slice() : [];
  history.push({ turn: s.turn, events: events, decisions: decisions, tension: newTension });

  update({
    phase: 'resolution', nationStates: nationStates, alliances: alliances,
    eliminated: elim, tension: newTension, history: history
  });
};

function renderMasterResolution() {
  var s = state;
  var t = TURNS[s.turn - 1];
  var history = s.history || [];
  var last = history[history.length - 1];
  var isEnd = s.turn >= 5 || s.tension >= 95;

  var html = '<div class="container">' +
    '<div style="text-align:center;margin-bottom:12px">' +
    '<div style="font-size:10px;color:var(--faint)">R√âSOLUTION ‚Äî TOUR ' + t.id + '</div>' +
    '<h2 style="font-size:22px;color:var(--gold);margin:6px 0">' + t.year + '</h2>' +
    '</div>' +
    renderTension(s.tension);

  html += '<div class="panel"><div class="panel-hdr">D√©cisions</div>';
  var active = s.activeNations || [];
  for (var i = 0; i < active.length; i++) {
    var nId = active[i];
    var n = NATIONS[nId];
    var dec = last && last.decisions ? last.decisions[nId] : null;
    html += '<div style="display:flex;align-items:center;gap:12px;padding:8px 0;border-bottom:1px solid #2a2520">' +
      '<span style="font-size:20px">' + n.flag + '</span>' +
      '<div style="flex:1"><div style="font-size:13px;font-weight:700;color:' + n.accent + '">' + n.short + '</div>' +
      '<div style="font-size:11px;color:var(--dim)">' + (dec ? dec.text : '‚Äî') + '</div></div>';
    if (dec) html += '<span class="tag" style="color:' + (dec.tension > 0 ? '#ff6080' : '#60d0a0') + '">' + dec.tag + '</span>';
    html += '</div>';
  }
  html += '</div>';

  if (last && last.events && last.events.length) {
    html += '<div class="panel" style="border-color:rgba(230,57,70,0.3)"><div class="panel-hdr" style="color:var(--red)">‚ö° Cons√©quences</div>';
    for (var i = 0; i < last.events.length; i++) {
      html += '<div style="font-size:13px;color:var(--text);margin-bottom:4px">' + last.events[i] + '</div>';
    }
    html += '</div>';
  }

  html += '<div style="text-align:center;margin:20px 0">' +
    '<button class="btn ' + (isEnd ? 'btn-red' : 'btn-gold') + '" onclick="nextTurn()">' + (isEnd ? '‚ö° D√©nouement' : 'Tour ' + (s.turn + 1) + ' ‚Üí') + '</button>' +
    '</div></div>';

  app.innerHTML = html;
}

window.nextTurn = function() {
  var s = state;
  if (s.turn >= 5 || s.tension >= 95) {
    update({ phase: 'endgame' });
  } else {
    update({ phase: 'event', turn: s.turn + 1, decisions: {} });
  }
};

function renderMasterEndgame() {
  var s = state;
  var war = s.tension >= 70;
  var active = s.activeNations || [];
  var elim = s.eliminated || [];

  var scores = {};
  for (var i = 0; i < active.length; i++) {
    var nId = active[i];
    if (elim.indexOf(nId) >= 0) { scores[nId] = 0; continue; }
    var st = s.nationStates[nId];
    scores[nId] = Math.round(20 + (war ? 0 : 30) + st.mil * 0.2 + st.ind * 0.3 + st.pop * 0.25 + st.dip * 0.25);
  }

  var ranked = active.slice().sort(function(a, b) { return (scores[b] || 0) - (scores[a] || 0); });
  var medals = ['ü•á', 'ü•à', 'ü•â'];

  var html = '<div class="container">' +
    '<div style="text-align:center;padding:30px 0">' +
    '<h1 style="font-size:32px;color:' + (war ? 'var(--red)' : 'var(--green)') + '">' + (war ? 'LA GRANDE GUERRE √âCLATE' : 'LA PAIX EST PR√âSERV√âE') + '</h1>' +
    '<p style="font-size:13px;color:var(--dim);max-width:500px;margin:10px auto">' + (war ? 'L\'engrenage des alliances a pr√©cipit√© l\'Europe dans la catastrophe.' : 'Contre toute attente, la diplomatie l\'a emport√©.') + '</p>' +
    '</div>' +
    renderTension(s.tension);

  html += '<div class="panel" style="border-color:rgba(196,163,90,0.3)"><div style="font-size:13px;color:var(--gold);margin-bottom:8px">üìö Et dans la r√©alit√© ?</div>' +
    '<p style="font-size:12px;color:var(--dim);line-height:1.6">' + (war ?
      'Comme dans votre simulation, la Premi√®re Guerre mondiale a √©clat√© en 1914. Questions : La guerre √©tait-elle in√©vitable ? Quelles d√©cisions ont le plus augment√© les tensions ?' :
      'Contrairement √† votre simulation, la vraie histoire a vu √©clater la guerre. Questions : Qu\'avez-vous fait diff√©remment ? Pourquoi les vrais dirigeants n\'ont-ils pas fait ces choix ?') +
    '</p></div>';

  html += '<div class="panel"><div class="panel-hdr">Classement final</div>';
  for (var i = 0; i < ranked.length; i++) {
    var nId = ranked[i];
    var n = NATIONS[nId];
    var isElim = elim.indexOf(nId) >= 0;
    html += '<div style="display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid #2a2520;opacity:' + (isElim ? '0.4' : '1') + '">' +
      '<div style="width:28px;text-align:center;font-size:' + (i < 3 ? '18px' : '14px') + '">' + (i < 3 ? medals[i] : (i + 1)) + '</div>' +
      '<span style="font-size:22px">' + n.flag + '</span>' +
      '<div style="flex:1"><div style="font-size:14px;font-weight:700;color:' + n.accent + '">' + n.short + '</div>' +
      (isElim ? '<div style="font-size:10px;color:var(--red)">√âlimin√©</div>' : '') + '</div>' +
      '<div style="font-size:22px;font-weight:700;color:' + (i === 0 ? 'var(--gold)' : 'var(--dim)') + '">' + (scores[nId] || 0) + '</div>' +
      '</div>';
  }
  html += '</div>';

  html += '<div style="text-align:center;margin:20px 0"><button class="btn btn-gold" onclick="resetGame()">‚Ü∫ Nouvelle partie</button></div></div>';

  app.innerHTML = html;
}

window.resetGame = function() {
  update({
    phase: 'lobby', players: {}, nationStates: {}, alliances: {},
    decisions: {}, tension: 10, turn: 0, eliminated: [], telegrams: [], history: []
  });
};

// === NATION VIEW ===
function renderNation() {
  var s = state;
  var players = s.players || {};
  var me = players[playerId];

  // Debug
  console.log('renderNation - phase:', s.phase, 'playerId:', playerId, 'me:', me, 'activeNations:', s.activeNations);

  if (s.phase === 'lobby') {
    renderNationLobby(me);
    return;
  }

  // Si pas de joueur trouv√© ou nation pas dans la partie, permettre de rejoindre
  if (!me || !me.nation) {
    app.innerHTML = '<div class="container" style="text-align:center;padding:60px">' +
      '<p style="color:var(--dim)">Vous n\'avez pas choisi de nation.</p>' +
      '<p style="color:var(--faint);font-size:12px;margin-top:8px">La partie a d√©j√† commenc√© sans vous.</p>' +
      '</div>';
    return;
  }

  if ((s.activeNations || []).indexOf(me.nation) < 0) {
    app.innerHTML = '<div class="container" style="text-align:center;padding:60px">' +
      '<p style="color:var(--dim)">Votre nation (' + NATIONS[me.nation].flag + ' ' + NATIONS[me.nation].short + ') n\'est pas dans cette partie.</p>' +
      '</div>';
    return;
  }

  var nId = me.nation;
  if ((s.eliminated || []).indexOf(nId) >= 0) {
    var n = NATIONS[nId];
    app.innerHTML = '<div class="container" style="text-align:center;padding:60px">' +
      '<span style="font-size:64px">' + n.flag + '</span>' +
      '<h2 style="color:var(--red);margin:16px 0">R√âVOLUTION !</h2>' +
      '<p style="color:var(--dim)">Votre gouvernement est tomb√©.</p></div>';
    return;
  }

  if (s.phase === 'event') renderNationEvent(nId);
  else if (s.phase === 'playing') renderNationPlaying(nId);
  else if (s.phase === 'resolution') renderNationResolution(nId);
  else if (s.phase === 'endgame') renderNationEndgame(nId);
}

function renderNationLobby(me) {
  var s = state;
  var players = s.players || {};
  var taken = [];
  for (var id in players) {
    if (id !== playerId && players[id].nation) taken.push(players[id].nation);
  }
  var sel = s.selectedNations || [];

  var html = '<div class="container" style="max-width:600px">' +
    '<div style="text-align:center;padding:20px 0">' +
    '<h1 style="font-size:32px;color:var(--gold)">POUDRI√àRE</h1>' +
    '<div class="code-box" style="font-size:18px;padding:8px 16px">' + room + '</div>' +
    '</div>';

  html += '<div class="panel" style="margin-bottom:16px">' +
    '<h3 style="color:var(--gold);margin-bottom:10px">üéÆ Bienvenue !</h3>' +
    '<p style="font-size:12px;color:var(--dim);line-height:1.6">Vous allez incarner une grande puissance europ√©enne entre 1890 et 1914. Choisissez votre nation et d√©fendez ses int√©r√™ts !</p>' +
    '</div>';

  html += '<div class="panel"><div class="panel-hdr">Choisissez votre nation</div>';
  for (var i = 0; i < sel.length; i++) {
    var k = sel[i];
    var n = NATIONS[k];
    var isTaken = taken.indexOf(k) >= 0;
    var isMine = me && me.nation === k;

    html += '<div class="nation-card' + (isMine ? ' sel' : '') + (isTaken && !isMine ? ' taken' : '') + '" ' +
      'onclick="' + (isTaken && !isMine ? '' : 'pickNation(\'' + k + '\')') + '" ' +
      'style="margin-bottom:10px;' + (isMine ? 'border-color:' + n.accent : '') + '">' +
      '<div style="display:flex;align-items:center;gap:12px">' +
      '<span style="font-size:32px">' + n.flag + '</span>' +
      '<div style="flex:1">' +
      '<div style="font-size:15px;font-weight:700;color:' + (isMine ? n.accent : isTaken ? 'var(--faint)' : 'var(--text)') + '">' + n.name + '</div>' +
      '<div style="font-size:11px;color:var(--dim)">' + n.leader + '</div>' +
      '<div style="font-size:11px;color:var(--faint);margin-top:4px">' + n.desc + '</div>' +
      '</div>' +
      (isTaken && !isMine ? '<span style="color:var(--red);font-size:11px">‚úó Pris</span>' : '') +
      (isMine ? '<span style="color:var(--green);font-size:11px">‚úì</span>' : '') +
      '</div></div>';
  }
  html += '</div>';

  if (me && me.nation) {
    var n = NATIONS[me.nation];
    html += '<div style="text-align:center;padding:14px;background:var(--card);border:1px solid rgba(129,178,154,0.4);border-radius:6px">' +
      '<div style="color:var(--green);font-size:14px">‚úì Vous jouez ' + n.flag + ' ' + n.name + '</div>' +
      '<div style="color:var(--dim);font-size:12px;margin-top:4px">En attente du lancement...</div>' +
      '</div>';
  }

  html += '</div>';
  app.innerHTML = html;
}

window.pickNation = function(k) {
  set('players/' + playerId, { nation: k, joinedAt: Date.now() });
};

function renderNationEvent(nId) {
  var s = state;
  var n = NATIONS[nId];
  var t = TURNS[s.turn - 1];

  var html = '<div class="container">' +
    '<div style="display:flex;align-items:center;gap:10px;margin-bottom:16px;border-bottom:1px solid var(--border);padding-bottom:12px">' +
    '<span style="font-size:32px">' + n.flag + '</span>' +
    '<div><div style="font-size:16px;font-weight:700;color:' + n.accent + '">' + n.name + '</div>' +
    '<div style="font-size:11px;color:var(--dim)">' + n.leader + '</div></div>' +
    '</div>' +
    renderTension(s.tension);

  html += '<div class="panel" style="text-align:center;border-color:rgba(196,163,90,0.3)">' +
    '<div style="font-size:10px;letter-spacing:2px;color:var(--faint)">TOUR ' + t.id + ' / 5</div>' +
    '<h2 style="font-size:22px;color:var(--gold);margin:6px 0">' + t.year + ' ‚Äî ' + t.title + '</h2>' +
    '<p style="font-size:13px;color:var(--dim);line-height:1.6;margin:12px 0">' + t.desc + '</p>' +
    '<div style="background:var(--bg);border:1px solid rgba(196,163,90,0.3);border-radius:4px;padding:12px;text-align:left">' +
    '<div style="font-size:10px;color:var(--gold);letter-spacing:2px;margin-bottom:4px">üì∞ √âV√âNEMENT</div>' +
    '<div style="font-size:12px;color:var(--text);line-height:1.5">' + t.event + '</div>' +
    '<div style="font-size:11px;color:var(--dim);margin-top:8px;font-style:italic;border-top:1px solid var(--border);padding-top:8px">üí° ' + t.context + '</div>' +
    '</div></div>';

  // Briefing
  html += '<div class="briefing" style="border-color:' + n.accent + '44">' +
    '<div style="font-size:13px;color:' + n.accent + ';margin-bottom:8px">' + n.flag + ' Briefing : ' + n.name + '</div>' +
    '<p style="font-size:12px;color:var(--dim);line-height:1.6">' + n.brief + '</p>' +
    '<div style="margin-top:10px;font-size:11px">' +
    '<span style="color:var(--green)">Alli√©s : </span>' + n.allies.map(function(a) { return NATIONS[a] ? NATIONS[a].flag + ' ' + NATIONS[a].short : ''; }).join(', ') +
    '<span style="color:var(--red);margin-left:12px">Rivaux : </span>' + n.rivals.map(function(a) { return NATIONS[a] ? NATIONS[a].flag + ' ' + NATIONS[a].short : ''; }).join(', ') +
    '</div></div>';

  html += '<div style="text-align:center;padding:14px;background:var(--card);border:1px solid var(--border);border-radius:6px">' +
    '<div style="color:var(--dim);font-size:13px">‚è≥ Lisez le contexte et pr√©parez votre strat√©gie...</div>' +
    '</div></div>';

  app.innerHTML = html;
}

function renderNationPlaying(nId) {
  console.log('renderNationPlaying called for', nId);
  var s = state;
  var n = NATIONS[nId];
  var t = TURNS[s.turn - 1];
  var st = s.nationStates[nId];
  
  if (!st) {
    console.error('No nationStates for', nId, 'available states:', Object.keys(s.nationStates || {}));
    app.innerHTML = '<div class="container" style="text-align:center;padding:60px"><p style="color:var(--red)">Erreur: donn√©es de nation introuvables</p></div>';
    return;
  }
  
  var myDec = s.decisions ? s.decisions[nId] : null;
  var alliances = s.alliances ? (s.alliances[nId] || []) : [];
  var tgs = (s.telegrams || []).filter(function(tg) {
    return tg.from === nId || tg.to === nId || !tg.secret;
  });

  var html = '<div class="container">' +
    '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">' +
    '<div style="display:flex;align-items:center;gap:10px">' +
    '<span style="font-size:28px">' + n.flag + '</span>' +
    '<div><div style="font-size:15px;font-weight:700;color:' + n.accent + '">' + n.name + '</div>' +
    '<div style="font-size:10px;color:var(--dim)">Tour ' + t.id + ' ‚Ä¢ ' + t.year + '</div></div>' +
    '</div>' +
    '<button class="btn btn-ghost" style="font-size:11px;padding:6px 12px" onclick="openTelegram(\'' + nId + '\')">‚ö° T√©l√©gramme</button>' +
    '</div>' +
    renderTension(s.tension);

  // Stats
  html += '<div class="panel">' +
    '<div class="panel-hdr">√âtat de ' + n.short + '</div>' +
    renderGauge(st.mil, 'var(--red)', '‚öî Militaire') +
    renderGauge(st.ind, 'var(--gold)', 'üí∞ Industrie') +
    renderGauge(st.pop, 'var(--green)', '‚úä Stabilit√© populaire') +
    renderGauge(st.dip, 'var(--blue)', 'üïä Diplomatie') +
    '</div>';

  // Allies
  if (alliances.length) {
    html += '<div style="font-size:12px;color:var(--dim);margin-bottom:12px;padding:8px 10px;background:var(--card);border-radius:4px">' +
      '<strong>Vos alli√©s :</strong> ' + alliances.map(function(a) { return NATIONS[a] ? NATIONS[a].flag + ' ' + NATIONS[a].short : ''; }).join(', ') +
      '</div>';
  }

  // Pressures
  var indGap = Math.abs(st.ind - n.pInd);
  var debtL = indGap > 30 ? 'CRITIQUE' : indGap > 15 ? '√âlev√©' : 'Normal';
  var debtC = indGap > 30 ? 'var(--red)' : indGap > 15 ? 'var(--orange)' : 'var(--green)';
  var revL = st.pop < 20 ? 'IMMINENT' : st.pop < 35 ? '√âlev√©' : st.pop < 50 ? 'Mod√©r√©' : 'Faible';
  var revC = st.pop < 20 ? 'var(--red)' : st.pop < 35 ? 'var(--orange)' : 'var(--green)';

  html += '<div class="panel"><div class="panel-hdr">Pressions int√©rieures</div>' +
    '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;text-align:center">' +
    '<div style="padding:8px;background:var(--bg);border-radius:4px"><div style="font-size:10px;color:var(--gold)">üí∞ Industriels</div><div style="font-size:11px;font-weight:700;color:' + debtC + '">' + debtL + '</div></div>' +
    '<div style="padding:8px;background:var(--bg);border-radius:4px"><div style="font-size:10px;color:var(--red)">‚öî G√©n√©raux</div><div style="font-size:11px;color:' + (st.mil < n.pMil - 20 ? 'var(--red)' : 'var(--green)') + '">' + (st.mil < n.pMil - 20 ? 'M√©contents' : 'Satisfaits') + '</div></div>' +
    '<div style="padding:8px;background:var(--bg);border-radius:4px"><div style="font-size:10px;color:var(--green)">‚úä Peuple</div><div style="font-size:11px;font-weight:700;color:' + revC + '">R√©vol: ' + revL + '</div></div>' +
    '</div>';
  if (st.pop < 30) {
    html += '<div style="margin-top:8px;padding:8px;background:#2a151a;border:1px solid rgba(230,57,70,0.3);border-radius:4px;font-size:11px;color:var(--red)">‚ö†Ô∏è Attention ! Stabilit√© < 15 = R√©volution !</div>';
  }
  html += '</div>';

  // Telegrams
  if (tgs.length) {
    html += '<div class="panel"><div class="panel-hdr">üì® T√©l√©grammes</div><div style="max-height:140px;overflow-y:auto">';
    for (var i = 0; i < tgs.length; i++) {
      var tg = tgs[i];
      html += '<div class="tg-msg" style="' + (tg.to === nId ? 'border-left:3px solid var(--gold)' : '') + '">' +
        '<strong>' + (NATIONS[tg.from] ? NATIONS[tg.from].flag : '?') + ' ‚Üí ' + (NATIONS[tg.to] ? NATIONS[tg.to].flag : '?') + '</strong> ' +
        '<span style="float:right;color:#8a7a60">' + (tg.secret ? 'üîí' : 'üì¢') + '</span><br>' +
        '¬´ ' + tg.message + ' ¬ª</div>';
    }
    html += '</div></div>';
  }

  // Decisions
  if (!myDec) {
    html += '<div class="panel" style="border-color:rgba(196,163,90,0.4)"><div class="panel-hdr">‚öñÔ∏è C\'est √† vous de d√©cider !</div>' +
      '<p style="font-size:12px;color:var(--dim);margin-bottom:12px">Choisissez l\'action de ' + n.name + ' ce tour.</p>';
    var decs = DECISIONS[s.turn];
    for (var i = 0; i < decs.length; i++) {
      var d = decs[i];
      html += '<div class="dec-card" onclick="submitDecision(\'' + nId + '\',\'' + d.id + '\')">' +
        '<div style="font-size:14px;font-weight:600;color:var(--text);margin-bottom:4px">' + d.text + '</div>' +
        '<div style="font-size:12px;color:var(--dim);margin-bottom:8px">' + d.desc + '</div>' +
        '<div>';
      if (d.fx.mil) html += '<span class="tag" style="color:' + (d.fx.mil > 0 ? 'var(--red)' : 'var(--blue)') + '">‚öî' + (d.fx.mil > 0 ? '+' : '') + d.fx.mil + '</span>';
      if (d.fx.ind) html += '<span class="tag" style="color:' + (d.fx.ind > 0 ? 'var(--gold)' : 'var(--orange)') + '">üí∞' + (d.fx.ind > 0 ? '+' : '') + d.fx.ind + '</span>';
      if (d.fx.pop) html += '<span class="tag" style="color:' + (d.fx.pop > 0 ? 'var(--green)' : 'var(--orange)') + '">‚úä' + (d.fx.pop > 0 ? '+' : '') + d.fx.pop + '</span>';
      if (d.fx.dip) html += '<span class="tag" style="color:' + (d.fx.dip > 0 ? 'var(--blue)' : 'var(--orange)') + '">üïä' + (d.fx.dip > 0 ? '+' : '') + d.fx.dip + '</span>';
      html += '<span class="tag" style="color:' + (d.tension > 0 ? '#ff6080' : '#60d0a0') + ';background:' + (d.tension > 0 ? '#2a1520' : '#152a20') + '">Tension ' + (d.tension > 0 ? '+' : '') + d.tension + '</span>';
      html += '</div></div>';
    }
    html += '</div>';
  } else {
    html += '<div class="panel" style="text-align:center;border-color:var(--green)">' +
      '<div style="font-size:16px;color:var(--green);margin-bottom:6px">‚úì D√©cision enregistr√©e !</div>' +
      '<div style="font-size:13px;color:var(--text)">' + myDec.text + '</div>' +
      '<div style="font-size:11px;color:var(--dim);margin-top:4px">' + myDec.desc + '</div>' +
      '<div style="font-size:11px;color:var(--faint);margin-top:10px">En attente des autres nations...</div>' +
      '</div>';
  }

  // Briefing button
  html += '<button class="btn btn-ghost" style="width:100%;margin-top:8px;font-size:11px" onclick="showBriefing(\'' + nId + '\')">üìñ Revoir le briefing</button>';

  html += '</div>';

  // Telegram modal placeholder
  html += '<div id="tgModal" style="display:none"></div>';

  app.innerHTML = html;
}

window.openTelegram = function(nId) {
  var s = state;
  var n = NATIONS[nId];
  var active = s.activeNations || [];
  var elim = s.eliminated || [];

  var opts = '';
  for (var i = 0; i < active.length; i++) {
    var k = active[i];
    if (k !== nId && elim.indexOf(k) < 0) {
      opts += '<option value="' + k + '">' + NATIONS[k].flag + ' ' + NATIONS[k].short + '</option>';
    }
  }

  var modal = document.createElement('div');
  modal.className = 'overlay';
  modal.id = 'tgOverlay';
  modal.onclick = function(e) { if (e.target === modal) modal.remove(); };
  modal.innerHTML = '<div class="tg-paper" onclick="event.stopPropagation()">' +
    '<div style="text-align:center;border-bottom:2px solid #8a7a60;padding-bottom:8px;margin-bottom:12px">' +
    '<div style="font-size:10px;letter-spacing:3px;color:#8a7a60">‚ö° T√âL√âGRAMME ‚ö°</div></div>' +
    '<div style="font-size:11px;color:#6a5a40;margin-bottom:6px">DE : ' + n.flag + ' ' + n.short + '</div>' +
    '<div style="font-size:11px;color:#6a5a40;margin-bottom:4px">√Ä :</div>' +
    '<select id="tgTo" style="margin-bottom:8px;background:#ede8d8;border:1px solid #8a7a60;padding:8px">' +
    '<option value="">‚Äî Destinataire ‚Äî</option>' + opts + '</select>' +
    '<textarea id="tgMsg" placeholder="Votre message..." maxlength="180" style="height:70px;background:#ede8d8;border:1px solid #8a7a60;font-family:\'Special Elite\',monospace;font-size:12px;resize:none;padding:8px;color:#2a2010"></textarea>' +
    '<label style="display:flex;align-items:center;gap:6px;margin-top:8px;font-size:11px;cursor:pointer">' +
    '<input type="checkbox" id="tgSec"> üîí Secret</label>' +
    '<div style="display:flex;gap:8px;margin-top:12px">' +
    '<button onclick="document.getElementById(\'tgOverlay\').remove()" style="flex:1;padding:8px;background:none;border:1px solid #8a7a60;font-family:\'Special Elite\',monospace;cursor:pointer;color:#6a5a40">Annuler</button>' +
    '<button onclick="sendTelegram(\'' + nId + '\')" style="flex:1;padding:8px;background:#2a2010;color:#f5f0e1;border:none;font-family:\'Special Elite\',monospace;cursor:pointer">Envoyer</button>' +
    '</div></div>';
  document.body.appendChild(modal);
};

window.sendTelegram = function(from) {
  var to = document.getElementById('tgTo').value;
  var msg = document.getElementById('tgMsg').value.trim();
  var secret = document.getElementById('tgSec').checked;
  if (!to || !msg) { alert('Choisissez un destinataire et √©crivez un message !'); return; }

  var tgs = state.telegrams ? state.telegrams.slice() : [];
  tgs.push({ from: from, to: to, message: msg, secret: secret, ts: Date.now() });
  set('telegrams', tgs);
  document.getElementById('tgOverlay').remove();
};

window.submitDecision = function(nId, dId) {
  if (state.decisions && state.decisions[nId]) return;
  var decs = DECISIONS[state.turn];
  var dec = null;
  for (var i = 0; i < decs.length; i++) {
    if (decs[i].id === dId) { dec = decs[i]; break; }
  }
  if (dec) set('decisions/' + nId, dec);
};

window.showBriefing = function(nId) {
  var n = NATIONS[nId];
  var modal = document.createElement('div');
  modal.className = 'overlay';
  modal.onclick = function(e) { if (e.target === modal) modal.remove(); };
  modal.innerHTML = '<div class="modal" onclick="event.stopPropagation()">' +
    '<div style="font-size:16px;color:' + n.accent + ';margin-bottom:12px">' + n.flag + ' ' + n.name + '</div>' +
    '<p style="font-size:13px;color:var(--dim);line-height:1.7;margin-bottom:16px">' + n.brief + '</p>' +
    '<div style="font-size:12px;margin-bottom:12px">' +
    '<div style="color:var(--green);margin-bottom:4px"><strong>Alli√©s :</strong> ' + n.allies.map(function(a) { return NATIONS[a] ? NATIONS[a].flag + ' ' + NATIONS[a].short : ''; }).join(', ') + '</div>' +
    '<div style="color:var(--red)"><strong>Rivaux :</strong> ' + n.rivals.map(function(a) { return NATIONS[a] ? NATIONS[a].flag + ' ' + NATIONS[a].short : ''; }).join(', ') + '</div>' +
    '</div>' +
    '<div style="text-align:center"><button class="btn btn-gold" onclick="this.closest(\'.overlay\').remove()">Compris !</button></div>' +
    '</div>';
  document.body.appendChild(modal);
};

function renderNationResolution(nId) {
  var s = state;
  var n = NATIONS[nId];
  var st = s.nationStates[nId];
  var history = s.history || [];
  var last = history[history.length - 1];
  var myDec = last && last.decisions ? last.decisions[nId] : null;

  var html = '<div class="container">' +
    '<div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">' +
    '<span style="font-size:28px">' + n.flag + '</span>' +
    '<div><div style="font-size:15px;font-weight:700;color:' + n.accent + '">' + n.name + '</div>' +
    '<div style="font-size:10px;color:var(--dim)">R√©solution Tour ' + s.turn + '</div></div>' +
    '</div>' +
    renderTension(s.tension);

  if (myDec) {
    html += '<div class="panel"><div class="panel-hdr">Votre d√©cision</div>' +
      '<div style="font-size:14px;color:var(--text)">' + myDec.text + '</div>' +
      '<div style="font-size:12px;color:var(--dim)">' + myDec.desc + '</div></div>';
  }

  html += '<div class="panel"><div class="panel-hdr">Nouvel √©tat</div>' +
    renderGauge(st.mil, 'var(--red)', '‚öî Militaire') +
    renderGauge(st.ind, 'var(--gold)', 'üí∞ Industrie') +
    renderGauge(st.pop, 'var(--green)', '‚úä Stabilit√©') +
    renderGauge(st.dip, 'var(--blue)', 'üïä Diplomatie') +
    '</div>';

  if (last && last.events && last.events.length) {
    html += '<div class="panel" style="border-color:rgba(230,57,70,0.3)"><div class="panel-hdr" style="color:var(--red)">‚ö° Cons√©quences</div>';
    for (var i = 0; i < last.events.length; i++) {
      html += '<div style="font-size:12px;color:var(--text);margin-bottom:4px">' + last.events[i] + '</div>';
    }
    html += '</div>';
  }

  html += '<div style="text-align:center;padding:14px;background:var(--card);border:1px solid var(--border);border-radius:6px">' +
    '<div style="color:var(--dim);font-size:13px">‚è≥ En attente du prochain tour...</div></div></div>';

  app.innerHTML = html;
}

function renderNationEndgame(nId) {
  var s = state;
  var n = NATIONS[nId];
  var st = s.nationStates[nId];
  var war = s.tension >= 70;
  var score = Math.round(20 + (war ? 0 : 30) + st.mil * 0.2 + st.ind * 0.3 + st.pop * 0.25 + st.dip * 0.25);

  var html = '<div class="container" style="text-align:center;padding-top:40px">' +
    '<span style="font-size:56px">' + n.flag + '</span>' +
    '<h2 style="font-size:26px;color:' + (war ? 'var(--red)' : 'var(--green)') + ';margin:16px 0">' + (war ? 'LA GUERRE √âCLATE' : 'LA PAIX EST PR√âSERV√âE') + '</h2>' +
    '<div style="font-size:48px;font-weight:700;color:var(--gold);margin:20px 0">' + score + '</div>' +
    '<div style="font-size:14px;color:var(--dim)">points</div>' +
    '<div style="color:var(--faint);font-size:12px;margin-top:24px">Regardez l\'√©cran projet√© pour le classement !</div>' +
    '</div>';

  app.innerHTML = html;
}

// Init
render();
</script>
</body>
</html>
